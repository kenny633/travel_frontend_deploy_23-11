(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[892],{6990:(e,t,s)=>{Promise.resolve().then(s.bind(s,1408))},9580:(e,t,s)=>{"use strict";s.d(t,{Z:()=>l});var a=s(7437);s(2265),s(1532);let l=()=>(0,a.jsxs)("div",{className:"loading-container",children:[(0,a.jsx)("div",{className:"loading-spinner"}),(0,a.jsx)("p",{className:"loading-text",children:"加载中，请稍候..."})]})},451:(e,t,s)=>{"use strict";s.d(t,{Z:()=>n});var a=s(7437),l=s(2265),r=s(3390);let n=e=>{let{postId:t,initialLikes:s,initialCollections:n,initialIsLiked:o,initialIsCollected:i,initialViews:c}=e,[d,m]=(0,l.useState)(s),[h,u]=(0,l.useState)(n),[g,x]=(0,l.useState)(o),[p,b]=(0,l.useState)(i),[f,A]=(0,l.useState)(c),[y,w]=(0,l.useState)(!1),[j,v]=(0,l.useState)(null);(0,l.useEffect)(()=>{(async()=>{try{let e=await (0,r.U2)("/posts/".concat(t,"/actions"),{},!0);m(e.likes),u(e.collections),x(e.isLiked),b(e.isCollected),A(e.views)}catch(e){v("Error fetching post actions: "+e.message)}})()},[t]);let N=async()=>{if(!localStorage.getItem("token")){alert("Please login first");return}if(!y){w(!0),v(null),m(g?d-1:d+1),x(!g);try{let e=await (0,r.v_)("/posts/".concat(t,"/like"),{method:"POST"});if(200!==e.status)throw Error("Network response was not ok");let s=await e;m(s.likes),x(s.hasLiked)}catch(e){v("Error liking post: "+e.message),m(g?d+1:d-1),x(e=>!e)}finally{w(!1)}}},k=async()=>{if(!localStorage.getItem("token")){alert("Please login first");return}if(!y){w(!0),v(null),u(p?h-1:h+1),b(e=>!e);try{let e=await (0,r.v_)("/posts/".concat(t,"/collect"),{},!0);if(200!==e.status)throw Error("Network response was not ok");u(e.collections),b(e.isCollected)}catch(e){v("Error collecting post: "+e.message),u(p?h+1:h-1),b(!p)}finally{w(!1)}}};return(0,a.jsxs)("div",{className:"flex space-x-4 mt-2 bg-transparent",children:[j&&(0,a.jsx)("div",{className:"text-red-500",children:j}),(0,a.jsxs)("button",{onClick:N,disabled:y,"aria-label":g?"Unlike post":"Like post",className:"flex items-center space-x-1 px-4 py-2 rounded-lg transition duration-200 ease-in-out ".concat(g?"text-red-500 bg-gray-200 hover:bg-gray-300":"text-gray-500 bg-gray-200 hover:bg-gray-300"),children:[(0,a.jsx)("span",{children:g?"❤️":"\uD83E\uDD0D"}),(0,a.jsx)("span",{children:d})]}),(0,a.jsxs)("button",{onClick:k,disabled:y,"aria-label":p?"Uncollect post":"Collect post",className:"flex items-center space-x-1 px-4 py-2 rounded-lg transition duration-200 ease-in-out ".concat(p?"text-yellow-500 bg-gray-200 hover:bg-gray-300":"text-gray-500 bg-gray-200 hover:bg-gray-300"),children:[(0,a.jsx)("span",{children:p?"⭐":"☆"}),(0,a.jsx)("span",{children:h})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-1 px-4 py-2 rounded-lg transition duration-200 ease-in-out bg-gray-200 text-gray-800 hover:bg-gray-300",children:[(0,a.jsx)("span",{children:"\uD83D\uDC41️"}),(0,a.jsx)("span",{children:f})]})]})}},1408:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>u});var a=s(7437),l=s(2265),r=s(6463),n=s(3390),o=s(7138),i=s(6648);s(8316);var c=s(9580);let d={src:"/_next/static/media/del.982d3c5e.png",height:120,width:120,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAJFBMVEX///////////////////9MaXH///////////////////////9BjiGlAAAADHRSTlNsCitjhgBFcxg7lqTdtZYcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAN0lEQVR4nBXGQRIAIAgDsaUFFP3/fx1PCRF5TkYwN9fKO2yie3/YWAS1ZA9FIbt/PFK7KCWk6gEo8wEG06L3SQAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:8},m={src:"/_next/static/media/edit.391ed3cc.png",height:120,width:120,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAMAAADz0U65AAAAJ1BMVEVMaXH////////////////////////////////////////////////c+C/6AAAADHRSTlMAIIZboD/faQlKMMSid8+rAAAACXBIWXMAAAsTAAALEwEAmpwYAAAANklEQVR4nCXKWw7AMAwCwU2x4zx8//NWtHwwEgKAHG7YEcuqZ3hS97Qj7ALd+q87pFId8vmSLxrbANZGrlDhAAAAAElFTkSuQmCC",blurWidth:8,blurHeight:8};var h=s(451);let u=()=>{let{postId:e}=(0,r.useParams)(),[t,s]=(0,l.useState)(null),[u,g]=(0,l.useState)([]),[x,p]=(0,l.useState)(""),[b,f]=(0,l.useState)(null),[A,y]=(0,l.useState)(!1),[w,j]=(0,l.useState)([]),[v,N]=(0,l.useState)([]),[k,S]=(0,l.useState)(null),[_,C]=(0,l.useState)(!1),[E,D]=(0,l.useState)(1),[I,L]=(0,l.useState)(0),[P,U]=(0,l.useState)(1),[F,T]=(0,l.useState)("");(0,l.useEffect)(()=>{let t=async()=>{try{let t=await (0,n.U2)("/posts/".concat(e,"/getPostData"),{},!0);C(t.permission),s(t.post);let a=await (0,n.U2)("/posts/".concat(e,"/comments/").concat(E,"/").concat(5),!1);g(a.comments),U(a.totalPages);let l=await (0,n.U2)("/posts/recommendations/".concat(e),!1);j(l.recommendations),M(t.post.content)}catch(e){f("Failed to load post and comments"),console.error(e)}};e&&t()},[e]),(0,l.useEffect)(()=>{(async()=>{let t=await (0,n.U2)("/posts/".concat(e,"/comments/").concat(E,"/").concat(5),!1);g(t.comments),U(t.totalPages)})()},[E,I]);let M=e=>{if(!e)return;let t=new DOMParser().parseFromString(e,"text/html");N(Array.from(t.querySelectorAll("h1, h2, h3")).map((e,t)=>{let s="heading-".concat(t);return e.setAttribute("id",s),{text:e.innerText,id:s,level:e.tagName}})),s(e=>({...e,content:t.body.innerHTML}))},B=async t=>{if(t.preventDefault(),x.trim()){y(!0),f(null);try{let t=await (0,n.v_)("/posts/".concat(e,"/comments"),{content:x.trim()},!0);g(e=>[t,...e]),p(""),L(I+1)}catch(e){f(e.message),console.error("Comment submission error:",e)}finally{y(!1)}}},R=async t=>{if(null==localStorage.getItem("token")){alert("請先登入");return}try{let s=await (0,n.v_)("/posts/".concat(e,"/comments/").concat(t,"/like"),{},!1);O(s)}catch(e){console.error("Like error:",e),f("Failed to like comment")}},H=async t=>{if(null==localStorage.getItem("token")){alert("請先登入");return}try{let s=await (0,n.v_)("/posts/".concat(e,"/comments/").concat(t,"/dislike"),{},!1);O(s)}catch(e){console.error("Dislike error:",e),f("Failed to dislike comment")}},O=e=>{g(t=>t.map(t=>t._id===e._id?{...t,likes:e.likes,dislikes:e.dislikes,hasLiked:e.hasLiked,hasDisliked:e.hasDisliked}:t))},W=async()=>{if(window.confirm("您确定要删除这篇文章吗？"))try{await (0,n.v_)("/posts/".concat(e,"/delete"),{},!0),window.location.href="/"}catch(e){console.error("Delete post error:",e),f("Failed to delete post")}},X=async t=>{if(null==localStorage.getItem("token")){alert("請先登入");return}if(window.confirm("您确定要删除这条评论吗？"))try{await (0,n.v_)("/posts/".concat(e,"/comments/").concat(t,"/delete"),{},!0),g(e=>e.filter(e=>e._id!==t)),L(I+1)}catch(e){console.error("Delete comment error:",e),f("Failed to delete comment")}},Z=e=>{let t=document.getElementById(e);t&&(t.scrollIntoView({behavior:"smooth"}),setTimeout(()=>{S(e)},500))};return((0,l.useEffect)(()=>{let e=()=>{let e=v.map(e=>document.getElementById(e.id));window.scrollY;let t=null;e.forEach(e=>{let{top:s}=e.getBoundingClientRect();s>=0&&s<=window.innerHeight&&(t=e.id)}),t&&S(t)};return window.addEventListener("scroll",e),()=>{window.removeEventListener("scroll",e)}},[v]),t)?(0,a.jsx)("div",{className:"container mx-auto p-5",style:{maxWidth:"60%"},children:(0,a.jsxs)("div",{className:"main-content flex flex-col",children:[(0,a.jsxs)("div",{className:"post-content mb-10",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:t.title}),t.img_path&&(0,a.jsx)("div",{className:"image-container flex justify-center my-5",children:(0,a.jsx)("img",{src:t.img_path,alt:t.title||"Post image",className:"post-image max-w-full rounded-lg"})}),(0,a.jsx)("div",{className:"ql-editor",dangerouslySetInnerHTML:{__html:t.content}}),(0,a.jsxs)("p",{className:"post-date text-gray-500",children:["Posted on: ",new Date(t.Creation_time).toLocaleString()]}),(0,a.jsxs)("div",{className:"author-info font-semibold",children:[(0,a.jsx)("strong",{children:"发帖人:"})," ",t.user_id.username]}),_&&(0,a.jsxs)("div",{children:[(0,a.jsx)(o.default,{href:"/post/edit/".concat(t._id),children:(0,a.jsx)("button",{className:"edit-button bg-blue-500 text-white rounded px-2 py-1 ml-2 hover:bg-blue-600 ",children:(0,a.jsx)(i.default,{src:m,alt:"edit",width:20,height:20})})}),(0,a.jsx)("button",{className:"delete-button bg-red-500 text-white rounded px-2 py-1 ml-2 hover:bg-red-600",onClick:()=>W(t._id),children:(0,a.jsx)(i.default,{src:d,alt:"delete",width:20,height:20})})]})]}),(0,a.jsxs)("div",{className:"comment-section",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:"留言"}),(0,a.jsxs)("div",{className:"comment-input-container mb-5",children:[(0,a.jsx)("textarea",{className:"comment-input w-full p-3 border border-gray-300 rounded",placeholder:"在此輸入您的評論...",value:x,onChange:e=>p(e.target.value)}),(0,a.jsx)("button",{className:"comment-button bg-green-500 text-white rounded px-4 py-2 mt-2 hover:bg-green-600 disabled:bg-gray-300",onClick:B,disabled:A,children:A?"發表中...":"發表"})]}),(0,a.jsx)("div",{className:"comments-list space-y-6",children:u.map(e=>(0,a.jsxs)("div",{className:"comment flex border-b border-gray-200 py-4 items-start",children:[(0,a.jsx)(o.default,{href:"/user/".concat(e.user._id,"/"),children:(0,a.jsx)(i.default,{src:e.user.img_path,alt:"".concat(e.user.username," avatar"),width:50,height:50,className:"rounded-full w-12 h-12 mr-4"})}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("h4",{className:"font-semibold text-lg flex items-center",children:[e.user.name,e.user._id===t.user_id._id&&(0,a.jsx)("span",{className:"post-owner-label text-green-600 ml-2 text-sm",children:" (楼主)"})]}),(0,a.jsx)("p",{className:"mt-1 text-gray-800",children:e.content}),(0,a.jsxs)("p",{className:"comment-date text-gray-500 text-sm mt-1",children:["在"," ",new Date(e.Creation_time).toLocaleString("zh-CN",{hour12:!0,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-")," ","发布评论"]}),(0,a.jsxs)("div",{className:"comment-footer flex space-x-4 mt-3",children:[(0,a.jsxs)("button",{className:"like-button flex items-center border rounded px-3 py-1 transition ".concat(e.hasLiked?"bg-blue-200 border-blue-400":"bg-transparent border-gray-300 hover:bg-gray-100"),onClick:()=>R(e._id),children:["\uD83D\uDC4D ",e.likes||0]}),(0,a.jsxs)("button",{className:"dislike-button flex items-center border rounded px-3 py-1 transition ".concat(e.hasDisliked?"bg-red-200 border-red-400":"bg-transparent border-gray-300 hover:bg-gray-100"),onClick:()=>H(e._id),children:["\uD83D\uDC4E ",e.dislikes||0]}),e.permission&&(0,a.jsx)("button",{className:"delete-button bg-red-500 text-white rounded px-2 py-1 ml-2 hover:bg-red-600 flex items-center",onClick:()=>X(e._id),children:(0,a.jsx)(i.default,{src:d,alt:"delete",width:20,height:20})})]})]})]},e._id))}),P>1&&(0,a.jsxs)("div",{className:"pagination flex justify-center space-x-4 mt-6",children:[(0,a.jsx)("button",{onClick:()=>{E>1&&D(e=>e-1)},className:"px-4 py-2 border rounded ".concat(1===E?"opacity-50 cursor-not-allowed":"bg-gray-100 hover:bg-gray-200"," "),disabled:1===E,children:"上一页"}),(0,a.jsxs)("span",{className:"flex items-center",children:["Page ",E," of ",P]}),(0,a.jsx)("button",{onClick:()=>{E<P&&D(e=>e+1)},className:"px-4 py-2 border rounded ".concat(E===P?"opacity-50 cursor-not-allowed":"bg-gray-100 hover:bg-gray-200"," "),disabled:E===P,children:"下一页"}),(0,a.jsxs)("div",{className:"flex items-center ml-4",children:[(0,a.jsx)("input",{type:"text",value:F,onChange:e=>{T(e.target.value.replace(/\D/,""))},className:"w-16 text-center border rounded px-2 py-1",placeholder:"Page"}),(0,a.jsx)("button",{onClick:()=>{let e=parseInt(F,10);e>=1&&e<=P&&D(e),T("")},className:"ml-2 bg-blue-500 text-white rounded px-3 py-1 hover:bg-blue-600",children:"跳转"})]})]}),(0,a.jsxs)("div",{className:"recommendations-section mt-10",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:"相关推荐"}),(0,a.jsx)("div",{className:"recommendations-list flex flex-wrap gap-5",children:w.length>0?w.map(e=>(0,a.jsx)("div",{className:"recommendation flex flex-col items-center",children:(0,a.jsx)("a",{href:"/postsample/".concat(e._id),className:"recommendation-link",children:(0,a.jsxs)("div",{className:"recommendation-content flex",children:[(0,a.jsx)("img",{src:e.img_path,alt:e.title,className:"rec-image w-48 rounded"}),(0,a.jsxs)("div",{className:"rec-text flex-1 ml-4",children:[(0,a.jsx)("h4",{className:"font-semibold",children:e.title}),(0,a.jsxs)("p",{children:["相似度: ",e.similarity.toFixed(2)]})]})]})})},e._id)):(0,a.jsx)("p",{children:"没有找到相关推荐"})})]})]}),(0,a.jsxs)("div",{className:" fixed right-20 top-24 h-auto bg-transparent p-3",children:[(0,a.jsx)(h.Z,{postId:t._id}),v.length>0&&(0,a.jsxs)("div",{className:"toc fixed right-20 top-44 w-64 max-h-96 overflow-y-auto p-3 border border-gray-300 rounded bg-white shadow-lg",children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:"目录"}),(0,a.jsx)("ul",{children:v.map(e=>(0,a.jsxs)("li",{className:"toc-item flex items-center ".concat(k===e.id?"font-bold":""," mb-2"),children:[k===e.id&&(0,a.jsx)("span",{className:"indicator text-blue-400 mr-2",children:"•"}),(0,a.jsx)("button",{className:"toc-link toc-".concat(e.level.toLowerCase()," ").concat(k===e.id?"text-blue-600":"text-black"," text-left w-full py-2"),onClick:()=>Z(e.id),children:e.text})]},e.id))})]})]})]})}):(0,a.jsx)(c.Z,{})}},3426:(e,t,s)=>{"use strict";function a(){return localStorage.getItem("token")}function l(){localStorage.removeItem("token")}function r(){return localStorage.getItem("userId")}s.d(t,{LP:()=>a,gy:()=>l,n5:()=>r})},3390:(e,t,s)=>{"use strict";s.d(t,{Ix:()=>i,U2:()=>n,v_:()=>o});var a=s(3426);let l="http://localhost:3001";async function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(t.headers={"Content-Type":"application/json",...t.headers},s){let e=(0,a.LP)();e&&(t.headers.Authorization="Bearer ".concat(e))}try{let s=await fetch("".concat(l).concat(e),t);if(!s.ok)throw Error("请求错误！");return s.json()}catch(t){console.log("请求哪条api出错:","".concat(l).concat(e)),console.log("请求失败:",t)}}function n(e,t){return r(e,{method:"GET",needToken:t})}function o(e,t,s){return r(e,{method:"POST",body:JSON.stringify(t),needToken:s})}async function i(e){let t=new FormData;t.append("image",e);try{let e=await fetch("".concat(l,"/upload"),{method:"POST",body:t});if(!e.ok)throw Error("图片上传失败！");return await e.json()}catch(e){throw console.error("上传图片失败:",e),e}}},1532:()=>{}},e=>{var t=t=>e(e.s=t);e.O(0,[967,10,881,138,974,130,215,744],()=>t(6990)),_N_E=e.O()}]);